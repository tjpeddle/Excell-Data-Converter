<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADA Accommodation Combiner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap');
  :root{
    --bg:#0f1117;--surface:#181a23;--surface2:#21242f;
    --border:#2a2d3a;--border-hi:#3d4155;
    --text:#e8e9ed;--text-dim:#8b8fa3;
    --accent:#6c8aff;--accent-soft:rgba(108,138,255,.12);--accent-glow:rgba(108,138,255,.25);
    --green:#4ade80;--green-soft:rgba(74,222,128,.12);--red:#f87171;--amber:#fbbf24;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  .app{max-width:1200px;margin:0 auto;padding:40px 24px 80px}
  .header{text-align:center;margin-bottom:40px}
  .header-badge{display:inline-block;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);background:var(--accent-soft);padding:6px 16px;border-radius:100px;margin-bottom:16px}
  .header h1{font-size:36px;font-weight:700;margin-bottom:10px}
  .header h1 span{color:var(--accent)}
  .header p{color:var(--text-dim);font-size:15px;max-width:560px;margin:0 auto;line-height:1.6}
  .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:48px 32px;text-align:center;cursor:pointer;background:var(--surface);transition:all .25s}
  .upload-zone:hover{border-color:var(--accent)}
  .upload-zone.loaded{border-color:var(--green);border-style:solid}
  .upload-icon{font-size:36px;margin-bottom:12px}
  .upload-title{font-size:17px;font-weight:500;margin-bottom:6px}
  .upload-sub{font-size:13px;color:var(--text-dim)}
  #fileInput{display:none}
  .lib-status{text-align:center;margin-top:10px;font-size:12px;color:var(--text-dim)}
  .lib-status.ok{color:var(--green)}
  .lib-status.fail{color:var(--red)}
  .hidden{display:none !important}
  .config-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin:24px 0;overflow:hidden}
  .config-header{padding:16px 24px;border-bottom:1px solid var(--border)}
  .config-header h2{font-size:15px;font-weight:600}
  .config-body{padding:20px 24px}
  .config-hint{font-size:12px;color:var(--text-dim);margin-top:4px}
  .field-row{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:16px}
  .field-group{flex:1;min-width:200px}
  .field-group label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
  .field-group select,.field-group input[type="text"]{width:100%;font-family:inherit;font-size:14px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text)}
  .field-group select{appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238b8fa3' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
  .field-group select:focus,.field-group input:focus{border-color:var(--accent);outline:none}
  .filter-box{border:1px solid var(--border);border-radius:12px;background:var(--surface2);max-height:300px;overflow-y:auto;margin-top:8px}
  .filter-box-actions{display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface2);z-index:1}
  .filter-search{flex:1;font-family:inherit;font-size:13px;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  .filter-search::placeholder{color:var(--text-dim)}
  .filter-search:focus{border-color:var(--accent);outline:none}
  .btn-xs{font-size:11px;font-weight:500;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-family:inherit;white-space:nowrap}
  .btn-xs:hover{border-color:var(--accent);color:var(--accent)}
  .filter-item{display:flex;align-items:center;gap:10px;padding:8px 14px;cursor:pointer;user-select:none}
  .filter-item:hover{background:rgba(255,255,255,.03)}
  .filter-item input[type="checkbox"]{-webkit-appearance:none;appearance:none;width:16px;height:16px;border:2px solid var(--border-hi);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0;background:transparent}
  .filter-item input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
  .filter-item input[type="checkbox"]:checked::after{content:'\2713';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:10px;font-weight:700}
  .filter-label{font-size:13px;color:var(--text);flex:1}
  .filter-count{font-size:11px;color:var(--text-dim);background:var(--bg);padding:1px 7px;border-radius:100px}
  .selected-count{font-size:13px;color:var(--accent);font-weight:500;padding:8px 14px;border-top:1px solid var(--border);position:sticky;bottom:0;background:var(--surface2)}
  .chip-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{display:inline-flex;align-items:center;padding:8px 16px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;font-size:13px;color:var(--text-dim);transition:all .2s;user-select:none}
  .chip:hover{border-color:var(--accent)}
  .chip.active{border-color:var(--accent);background:var(--accent-soft);color:var(--accent)}
  .btn-primary{font-family:inherit;font-size:14px;font-weight:600;padding:14px 32px;border:none;border-radius:12px;background:var(--accent);color:white;cursor:pointer;box-shadow:0 4px 24px var(--accent-glow);margin-top:20px}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 32px var(--accent-glow)}
  .btn-primary:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;transform:none}
  .btn-export{font-family:inherit;font-size:13px;font-weight:600;padding:10px 24px;border:none;border-radius:10px;background:var(--green);color:#0f1117;cursor:pointer}
  .btn-export:hover{transform:translateY(-1px)}
  .stats-bar{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}
  .stat-chip{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 16px;font-size:13px;color:var(--text-dim)}
  .stat-chip strong{color:var(--text);font-size:16px;font-weight:700;margin-right:4px}
  .preview-section{margin-top:32px}
  .preview-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .preview-header h2{font-size:17px;font-weight:600}
  .table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px;background:var(--surface);max-height:600px;overflow-y:auto}
  table.main{width:100%;border-collapse:collapse;font-size:13px}
  table.main thead th{padding:12px 14px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);background:var(--surface2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2;white-space:nowrap}
  table.main tbody tr{border-bottom:1px solid var(--border)}
  table.main tbody tr:hover{background:var(--accent-soft)}
  table.main tbody tr:last-child{border-bottom:none}
  table.main tbody td{padding:10px 14px;vertical-align:top}
  .cat-label{font-weight:600;color:var(--text);font-size:12px;margin-right:4px}
  .accom-tag{display:inline-block;background:var(--accent-soft);color:var(--accent);padding:2px 8px;border-radius:4px;font-size:12px;margin:2px}
  .cat-group{margin-bottom:4px}
  .toast{position:fixed;bottom:32px;right:32px;background:var(--green);color:#0f1117;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:10000}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-badge">Accommodation Tool</div>
    <h1>ADA Accommodation <span>Combiner</span></h1>
    <p>Load your Excel file, select which accommodations to include, and export a consolidated report — one row per student.</p>
  </div>
  <div class="upload-zone" id="uploadZone">
    <div class="upload-icon">&#128194;</div>
    <div class="upload-title" id="uploadTitle">Drop your Excel file here or click to browse</div>
    <div class="upload-sub" id="uploadSub">.xlsx or .xls files</div>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
  </div>
  <div class="lib-status" id="libStatus">Loading Excel library...</div>

  <div class="config-panel hidden" id="configPanel">
    <div class="config-header"><h2>Configure Columns</h2></div>
    <div class="config-body">
      <div class="field-row">
        <div class="field-group"><label>Group By (Name/ID)</label><select id="selGroup"></select><div class="config-hint">Rows with the same value will be joined together</div></div>
        <div class="field-group"><label>Accommodation Column</label><select id="selAccom"></select><div class="config-hint">The column containing accommodation types</div></div>
      </div>
      <div class="field-row">
        <div class="field-group"><label>Filter Column (optional)</label><select id="selFilter"></select><div class="config-hint">Only include rows where this column matches a value</div></div>
        <div class="field-group"><label>Filter Value(s)</label><div id="filterValArea" class="config-hint">Select a filter column first</div></div>
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px">Additional Columns to Keep</label>
        <div class="config-hint">These will take the first value found per group</div>
        <div class="chip-row" id="chipRow"></div>
      </div>
      <div style="margin-top:20px">
        <label style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px">Select Accommodations to Include</label>
        <div class="config-hint">Check the specific accommodations you want — only checked items appear in the output</div>
        <div class="filter-box hidden" id="accomFilterBox">
          <div class="filter-box-actions">
            <input type="text" class="filter-search" id="accomSearch" placeholder="Search accommodations...">
            <button class="btn-xs" id="accomSelAll">All</button>
            <button class="btn-xs" id="accomSelNone">None</button>
          </div>
          <div id="accomList"></div>
          <div class="selected-count" id="accomSelectedCount">0 selected</div>
        </div>
      </div>
      <div style="margin-top:20px">
        <label style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px">Category Labels</label>
        <div class="config-hint">Toggle whether category names (e.g. "Housing Accommodation:", "Academic Accommodation:") appear before each group of items</div>
        <div class="chip-row" style="margin-top:8px">
          <span class="chip active" id="toggleCatLabels" style="cursor:pointer">Show Category Labels</span>
        </div>
      </div>
      <button class="btn-primary" id="consolidateBtn" disabled>Consolidate Rows</button>
    </div>
  </div>

  <div class="stats-bar hidden" id="statsBar"></div>
  <div class="preview-section hidden" id="previewSection">
    <div class="preview-header">
      <h2 id="previewTitle">Preview</h2>
      <button class="btn-export" id="exportBtn">Export to Excel</button>
    </div>
    <div class="table-wrap"><table class="main"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table></div>
  </div>
</div>

<script>
var XLSX_READY=false,pendingFile=null,libStatus=document.getElementById('libStatus');
function tryLoadXLSX(){
  var urls=['https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js','https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js','https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'];
  var idx=0;
  function tryNext(){
    if(idx>=urls.length){libStatus.textContent='Could not load library. Save this HTML to your computer and open in Chrome.';libStatus.className='lib-status fail';return;}
    var s=document.createElement('script');s.src=urls[idx];
    s.onload=function(){XLSX_READY=true;libStatus.textContent='Ready';libStatus.className='lib-status ok';setTimeout(function(){libStatus.style.display='none';},1500);if(pendingFile){processFile(pendingFile);pendingFile=null;}};
    s.onerror=function(){idx++;tryNext();};document.head.appendChild(s);
  }
  tryNext();
}
tryLoadXLSX();
</script>
<script>
var rawData=[],headers=[],fileName='',combinedData=[],combinedOtherHeaders=[];
var $=function(id){return document.getElementById(id);};

// Upload
$('uploadZone').addEventListener('click',function(e){if(e.target!==$('fileInput'))$('fileInput').click();});
$('uploadZone').addEventListener('dragover',function(e){e.preventDefault();$('uploadZone').style.borderColor='var(--accent)';});
$('uploadZone').addEventListener('dragleave',function(e){e.preventDefault();$('uploadZone').style.borderColor='';});
$('uploadZone').addEventListener('drop',function(e){e.preventDefault();$('uploadZone').style.borderColor='';if(e.dataTransfer.files.length>0)handleFile(e.dataTransfer.files[0]);});
$('fileInput').addEventListener('change',function(){if($('fileInput').files.length>0)handleFile($('fileInput').files[0]);});

function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

function handleFile(file){
  fileName=file.name.replace(/\.[^.]+$/,'');
  $('uploadTitle').textContent=file.name;
  $('uploadSub').textContent='Reading...';
  if(!XLSX_READY){$('uploadSub').textContent='Waiting for library...';pendingFile=file;return;}
  processFile(file);
}

function processFile(file){
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var d=new Uint8Array(e.target.result);
      var wb=XLSX.read(d,{type:'array'});
      var ws=wb.Sheets[wb.SheetNames[0]];
      var json=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      if(json.length<2)return;
      headers=[];
      for(var i=0;i<json[0].length;i++)headers.push(String(json[0][i]).trim());
      rawData=[];
      for(var r=1;r<json.length;r++){
        var obj={};
        for(var c=0;c<headers.length;c++)obj[headers[c]]=(json[r][c]!==undefined&&json[r][c]!==null)?json[r][c]:'';
        rawData.push(obj);
      }
      $('uploadZone').classList.add('loaded');
      $('uploadSub').textContent=rawData.length+' rows loaded';
      buildConfig();
    }catch(err){alert('Error: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}

function buildConfig(){
  var opts='';
  for(var i=0;i<headers.length;i++)opts+='<option value="'+i+'">Col '+String.fromCharCode(65+i)+': '+esc(headers[i])+'</option>';
  $('selGroup').innerHTML=opts;
  $('selAccom').innerHTML=opts;
  $('selFilter').innerHTML='<option value="-1">(No filter - use all rows)</option>'+opts;

  // Auto-detect group = col A
  $('selGroup').value='0';

  // Auto-detect accommodation = column with most "/"
  var best=-1,bestIdx=2;
  for(var c=0;c<headers.length;c++){var cnt=0;for(var r=0;r<Math.min(rawData.length,100);r++){if(String(rawData[r][headers[c]]).indexOf('/')>=0)cnt++;}if(cnt>best){best=cnt;bestIdx=c;}}
  $('selAccom').value=String(bestIdx);

  // Auto-detect filter = column containing "Approved" value
  var foundFilter=-1;
  for(var c=0;c<headers.length;c++){
    for(var r=0;r<Math.min(rawData.length,200);r++){
      if(String(rawData[r][headers[c]]).trim().toLowerCase()==='approved'){foundFilter=c;break;}
    }
    if(foundFilter>=0)break;
  }
  if(foundFilter===-1){for(var c=0;c<headers.length;c++){var h=headers[c].toLowerCase();if(h.indexOf('approv')>=0||h.indexOf('status')>=0){foundFilter=c;break;}}}
  $('selFilter').value=String(foundFilter);

  buildFilterValues();
  buildChips();
  buildAccomList();
  $('configPanel').classList.remove('hidden');
  $('previewSection').classList.add('hidden');
}

$('selFilter').addEventListener('change',function(){buildFilterValues();buildAccomList();});
$('selAccom').addEventListener('change',function(){buildAccomList();});
$('selGroup').addEventListener('change',function(){buildChips();});

function buildFilterValues(){
  var ci=parseInt($('selFilter').value);
  if(ci<0){$('filterValArea').innerHTML='<span class="config-hint">All rows will be used</span>';return;}
  var col=headers[ci],vals={};
  for(var i=0;i<rawData.length;i++){var v=String(rawData[i][col]).trim();if(v==='')v='(blank)';if(!vals[v])vals[v]=0;vals[v]++;}
  var html='<div class="filter-box" style="max-height:180px">';
  var keys=Object.keys(vals).sort();
  for(var i=0;i<keys.length;i++){var v=keys[i];var chk=(v.toLowerCase()==='approved')?' checked':'';
    html+='<label class="filter-item"><input type="checkbox" class="filterValCb" data-val="'+esc(v)+'"'+chk+'><span class="filter-label">'+esc(v)+'</span><span class="filter-count">'+vals[v]+'</span></label>';}
  html+='</div>';
  $('filterValArea').innerHTML=html;
  var cbs=$('filterValArea').querySelectorAll('.filterValCb');
  for(var i=0;i<cbs.length;i++)cbs[i].addEventListener('change',function(){buildAccomList();});
}

function buildChips(){
  $('chipRow').innerHTML='';
  var gi=parseInt($('selGroup').value),ai=parseInt($('selAccom').value);
  for(var i=0;i<headers.length;i++){
    if(i===gi||i===ai)continue;
    var ch=document.createElement('span');ch.className='chip';ch.textContent=headers[i];ch.setAttribute('data-idx',String(i));
    var h=headers[i].toLowerCase();
    if(h.indexOf('id')>=0||h.indexOf('class')>=0||h.indexOf('level')>=0||h.indexOf('semester')>=0||h.indexOf('approv')>=0||h.indexOf('status')>=0)ch.classList.add('active');
    ch.addEventListener('click',function(){this.classList.toggle('active');});
    $('chipRow').appendChild(ch);
  }
}

function getFilteredRows(){
  var fi=parseInt($('selFilter').value);
  if(fi<0)return rawData.slice();
  var col=headers[fi],sv={};
  var cbs=$('filterValArea').querySelectorAll('.filterValCb:checked');
  for(var i=0;i<cbs.length;i++)sv[cbs[i].getAttribute('data-val')]=true;
  if(Object.keys(sv).length===0)return rawData.slice();
  var out=[];
  for(var i=0;i<rawData.length;i++){var v=String(rawData[i][col]).trim();if(v==='')v='(blank)';if(sv[v])out.push(rawData[i]);}
  return out;
}

function buildAccomList(){
  var ai=parseInt($('selAccom').value),acol=headers[ai];
  var rows=getFilteredRows();
  var vals={};
  for(var i=0;i<rows.length;i++){var v=String(rows[i][acol]).trim();if(v==='')continue;if(!vals[v])vals[v]=0;vals[v]++;}
  var keys=Object.keys(vals).sort();
  $('accomList').innerHTML='';
  for(var i=0;i<keys.length;i++){
    var v=keys[i];
    var lbl=document.createElement('label');lbl.className='filter-item accom-filter-item';
    var cb=document.createElement('input');cb.type='checkbox';cb.checked=true;cb.className='accomCb';cb.setAttribute('data-val',v);
    cb.addEventListener('change',updateAccomCount);
    var sp=document.createElement('span');sp.className='filter-label';sp.textContent=v;
    var cnt=document.createElement('span');cnt.className='filter-count';cnt.textContent=String(vals[v]);
    lbl.appendChild(cb);lbl.appendChild(sp);lbl.appendChild(cnt);
    $('accomList').appendChild(lbl);
  }
  $('accomFilterBox').classList.remove('hidden');
  updateAccomCount();
  $('consolidateBtn').disabled=(keys.length===0);
}

function updateAccomCount(){
  var a=$('accomList').querySelectorAll('.accomCb'),c=$('accomList').querySelectorAll('.accomCb:checked');
  $('accomSelectedCount').textContent=c.length+' of '+a.length+' selected';
  $('consolidateBtn').disabled=(c.length===0);
}

$('accomSearch').addEventListener('input',function(){
  var q=$('accomSearch').value.toLowerCase();
  var items=$('accomList').querySelectorAll('.accom-filter-item');
  for(var i=0;i<items.length;i++){var t=items[i].querySelector('.filter-label').textContent.toLowerCase();items[i].style.display=t.indexOf(q)>=0?'':'none';}
});
$('accomSelAll').addEventListener('click',function(){var c=$('accomList').querySelectorAll('.accomCb');for(var i=0;i<c.length;i++)c[i].checked=true;updateAccomCount();});
$('accomSelNone').addEventListener('click',function(){var c=$('accomList').querySelectorAll('.accomCb');for(var i=0;i<c.length;i++)c[i].checked=false;updateAccomCount();});

$('toggleCatLabels').addEventListener('click',function(){this.classList.toggle('active');this.textContent=this.classList.contains('active')?'Show Category Labels':'Hide Category Labels';if(combinedData.length)renderPreview();});

// CONSOLIDATE
$('consolidateBtn').addEventListener('click',function(){try{doConsolidate();}catch(err){alert('Error: '+err.message);console.error(err);}});

function doConsolidate(){
  var gi=parseInt($('selGroup').value),ai=parseInt($('selAccom').value);
  var gcol=headers[gi],acol=headers[ai];
  var rows=getFilteredRows();

  // Selected accommodations
  var sa={};var acbs=$('accomList').querySelectorAll('.accomCb:checked');
  for(var i=0;i<acbs.length;i++)sa[acbs[i].getAttribute('data-val')]=true;

  var filtered=[];
  for(var i=0;i<rows.length;i++){var v=String(rows[i][acol]).trim();if(sa[v])filtered.push(rows[i]);}

  // Extra columns
  var extraCols=[];
  var chips=$('chipRow').querySelectorAll('.chip.active');
  for(var i=0;i<chips.length;i++)extraCols.push(parseInt(chips[i].getAttribute('data-idx')));

  // Group by col A, preserve order
  var orderList=[],groups={};
  for(var i=0;i<filtered.length;i++){
    var row=filtered[i],key=String(row[gcol]);
    if(!groups[key]){
      groups[key]={extras:{},accoms:[],seen:{}};
      for(var j=0;j<extraCols.length;j++)groups[key].extras[headers[extraCols[j]]]=row[headers[extraCols[j]]];
      orderList.push(key);
    }
    var accom=String(row[acol]).trim();
    if(!groups[key].seen[accom]){
      groups[key].seen[accom]=true;
      // Parse category (text before first "/")
      var slashIdx=accom.indexOf('/');
      var cat=slashIdx>0?accom.substring(0,slashIdx).trim():accom;
      var detail=slashIdx>0?accom.substring(slashIdx+1).trim():accom;
      groups[key].accoms.push({cat:cat,detail:detail,full:accom});
    }
  }

  combinedOtherHeaders=[];
  for(var j=0;j<extraCols.length;j++)combinedOtherHeaders.push(headers[extraCols[j]]);

  combinedData=[];
  for(var i=0;i<orderList.length;i++){
    var key=orderList[i],g=groups[key];

    // Group accoms by category, preserve order
    var byCat={},catOrder=[];
    for(var j=0;j<g.accoms.length;j++){
      var a=g.accoms[j];
      if(!byCat[a.cat]){byCat[a.cat]=[];catOrder.push(a.cat);}
      byCat[a.cat].push(a.detail);
    }

    // Build display text: "Housing Accommodation: Door Fob; Single Room | Academic: 1.5x Time"
    var textPartsWithCat=[];
    var textPartsNoCat=[];
    for(var j=0;j<catOrder.length;j++){
      textPartsWithCat.push(catOrder[j]+': '+byCat[catOrder[j]].join('; '));
      textPartsNoCat.push(byCat[catOrder[j]].join('; '));
    }

    combinedData.push({
      groupVal:key,
      extras:g.extras,
      accomText:textPartsWithCat.join(' | '),
      accomTextNoCat:textPartsNoCat.join(' | '),
      byCat:byCat,
      catOrder:catOrder
    });
  }

  $('statsBar').innerHTML=
    '<div class="stat-chip"><strong>'+filtered.length+'</strong> matching rows</div>'+
    '<div class="stat-chip"><strong>'+combinedData.length+'</strong> unique students</div>'+
    '<div class="stat-chip"><strong>'+Object.keys(sa).length+'</strong> accommodation types selected</div>';
  $('statsBar').classList.remove('hidden');
  renderPreview();
}

function renderPreview(){
  $('previewSection').classList.remove('hidden');
  $('previewTitle').textContent='Preview - '+combinedData.length+' students';

  var gi=parseInt($('selGroup').value);
  var th='<tr><th>'+esc(headers[gi])+'</th>';
  for(var i=0;i<combinedOtherHeaders.length;i++)th+='<th>'+esc(combinedOtherHeaders[i])+'</th>';
  th+='<th>Combined Accommodations</th></tr>';
  $('tableHead').innerHTML=th;

  $('tableBody').innerHTML='';
  for(var i=0;i<combinedData.length;i++){
    var row=combinedData[i],tr=document.createElement('tr');
    var td0=document.createElement('td');td0.textContent=String(row.groupVal);tr.appendChild(td0);
    for(var j=0;j<combinedOtherHeaders.length;j++){var td=document.createElement('td');td.textContent=String(row.extras[combinedOtherHeaders[j]]||'');tr.appendChild(td);}

    var tdA=document.createElement('td');tdA.style.lineHeight='1.6';tdA.style.minWidth='300px';
    var html='';
    var showCat=$('toggleCatLabels').classList.contains('active');
    for(var j=0;j<row.catOrder.length;j++){
      var cat=row.catOrder[j],items=row.byCat[cat];
      html+='<div class="cat-group">';
      if(showCat)html+='<span class="cat-label">'+esc(cat)+':</span> ';
      for(var k=0;k<items.length;k++)html+='<span class="accom-tag">'+esc(items[k])+'</span> ';
      html+='</div>';
    }
    tdA.innerHTML=html;
    tr.appendChild(tdA);
    $('tableBody').appendChild(tr);
  }
  $('previewSection').scrollIntoView({behavior:'smooth',block:'start'});
}

// Export
$('exportBtn').addEventListener('click',function(){
  if(!combinedData.length)return;
  if(!XLSX_READY){alert('Excel library not loaded.');return;}
  try{
    var gi=parseInt($('selGroup').value);
    var hdr=[headers[gi]];
    for(var i=0;i<combinedOtherHeaders.length;i++)hdr.push(combinedOtherHeaders[i]);
    hdr.push('Combined Accommodations');
    var wsData=[hdr];
    for(var i=0;i<combinedData.length;i++){
      var r=combinedData[i],row=[r.groupVal];
      for(var j=0;j<combinedOtherHeaders.length;j++)row.push(r.extras[combinedOtherHeaders[j]]||'');
      row.push($('toggleCatLabels').classList.contains('active')?r.accomText:r.accomTextNoCat);
      wsData.push(row);
    }
    var ws=XLSX.utils.aoa_to_sheet(wsData);
    var cols=[];cols.push({wch:25});
    for(var i=0;i<combinedOtherHeaders.length;i++)cols.push({wch:16});
    cols.push({wch:100});
    ws['!cols']=cols;
    var wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Combined');
    XLSX.writeFile(wb,fileName+'_Combined.xlsx');
    var toast=document.createElement('div');toast.className='toast';
    toast.textContent='Exported '+combinedData.length+' students';
    document.body.appendChild(toast);
    setTimeout(function(){if(toast.parentNode)toast.parentNode.removeChild(toast);},3500);
  }catch(err){alert('Export error: '+err.message);}
});
</script>
</body>
</html>
